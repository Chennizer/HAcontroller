<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-store" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Contrôleur — Dwell & Multi-boutons</title>
<style>
  :root{
    --bg:#000; --fg:#fff;
    --tile:#111; --tile-border:#333;
    --ok:#1ec97f; --err:#ff6b6b;
    --fill: rgba(255,0,0,.65);
    --size: clamp(260px, 50vmin, 520px);
    --dwell: 1500ms;
    --panel-bg:#ffffff; --panel-fg:#000;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{display:grid; place-items:center; background:var(--bg); color:var(--fg); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; -webkit-tap-highlight-color:transparent;}
  #settingsIcon{position:fixed; top:14px; right:14px; width:44px; height:44px; border-radius:50%; background:var(--panel-bg); color:var(--panel-fg); border:2px solid #ff2a8a; display:flex; align-items:center; justify-content:center; font-size:22px; line-height:1; cursor:pointer; z-index:10010; box-shadow:0 10px 30px rgba(0,0,0,.6);}
  #settingsIcon:active{ transform:scale(.98); }
  #menuPanel{position:fixed; top:70px; right:14px; width:min(480px, 94vw); background:var(--panel-bg); color:var(--panel-fg); border:2px solid #111; border-radius:12px; box-shadow:0 20px 50px rgba(0,0,0,.55); padding:14px; z-index:10011; display:none;}
  #menuPanel.show{ display:block; }
  #menuPanel h2{ margin:0 0 12px; font-size:18px; }
  #menuPanel h3{ margin:14px 0 8px; font-size:15px; }
  #menuPanel .radio{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  #menuPanel label{ font-weight:600; }
  #menuPanel select, #menuPanel input[type="number"], #menuPanel input[type="url"]{
    width:100%; background:#fff; color:#000; border:2px solid #222; border-radius:10px;
    padding:10px 12px; outline:none; font:inherit;
  }
  #menuPanel .row{ display:grid; grid-template-columns:1fr; gap:8px; }
  #menuPanel .cols{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  #menuPanel .applyRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

  .center{ display:grid; place-items:center; gap:18px; }
  .tile{ width:var(--size); height:var(--size); display:grid; place-items:center; background:var(--tile); border:2px solid var(--tile-border); border-radius:24px; position:relative; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.5); touch-action:none; }
  .icon{ width:40%; max-width:220px; aspect-ratio:1/1; display:block; transition:opacity .2s ease; }
  .icon path{ fill:#ddd; transition:fill .2s ease }
  .active .icon path{ fill:var(--ok) }
  .error  .icon path{ fill:var(--err) }

  /* Contenu image pour la "case" (carré dwell) */
  .content-img{
    width:80%; max-width:360px; height:auto; object-fit:contain; display:none; z-index:2;
  }
  .show-image .icon{ opacity:0; }
  .show-image .content-img{ display:block; }

  /* Overlay de remplissage: conservé tel quel */
  .fill{ position:absolute; inset:0; margin:auto; width:100%; height:100%; background:var(--fill); border-radius:inherit; transform: scale(0); transform-origin: 50% 50%; pointer-events:none; will-change: transform; z-index:1; }
  .fill.filling{ transition: transform var(--dwell) linear; transform: scale(1); }

  .grid{ display:grid; grid-template-columns: repeat(2, minmax(180px, 1fr)); gap:18px; width:min(920px, 94vw); }
  .grid.four{ grid-template-columns: repeat(4, minmax(140px, 1fr)); }
  .btnCard{ background:#101010; border:2px solid #2b2b2b; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.35); overflow:hidden; cursor:pointer; position:relative; display:flex; flex-direction:column; align-items:center; justify-content:stretch; width:100%; min-height:180px; touch-action:none; }
  .btnCard.active{ outline:3px solid var(--ok); outline-offset:-3px; }
  .btnCard.error { outline:3px solid var(--err); outline-offset:-3px; }
  .pic{ width:100%; aspect-ratio:16/10; display:block; background:#181818; object-fit:cover; }
  .label{ width:100%; padding:10px 12px; text-align:center; color:#ddd; font-weight:700; border-top:1px solid #2b2b2b; }

  .hud{ position:fixed; left:12px; bottom:12px; background:rgba(0,0,0,.55); color:#fff; padding:8px 10px; border-radius:10px; font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; max-width:80vw; white-space:pre-wrap; box-shadow:0 6px 20px rgba(0,0,0,.35); z-index:5; }
  @media (prefers-reduced-motion: reduce){ .fill.filling{ transition-duration: 1ms; } }
</style>
</head>
<body>

<button id="settingsIcon" title="Options" aria-haspopup="true" aria-expanded="false">⚙️</button>

<div id="menuPanel" role="dialog" aria-label="Options">
  <h2>Options</h2>

  <h3>Mode de déclenchement</h3>
  <div class="radio" role="radiogroup" aria-label="Mode">
    <label><input type="radio" name="mode" value="dwell"> Carré (dwell)</label>
    <label><input type="radio" name="mode" value="buttons2"> 2 boutons (plug1 + tuyarelay1)</label>
    <label><input type="radio" name="mode" value="buttons4"> 4 boutons (tous)</label>
  </div>

  <h3>Tuya relais 2 — Paramètres</h3>
  <label for="msInput">Durée (ms)</label>
  <input id="msInput" type="number" min="50" max="60000" step="50" value="1500" inputmode="numeric" />
  <div class="radio" role="radiogroup" aria-label="Mode d’action pour tuyarelay2" style="margin-top:8px">
    <label><input type="radio" name="fireMode2" value="momentary"> Momentané (ON → attente → OFF)</label>
    <label><input type="radio" name="fireMode2" value="toggle"> Bascule (TOGGLE)</label>
  </div>

  <h3>Action du carré (dwell)</h3>
  <label for="actionSelect" class="sr-only">Action du carré</label>
  <select id="actionSelect" aria-label="Choisir l'action du carré">
    <option value="plug1">Prise 1 — plug1</option>
    <option value="plug2">Prise 2 — plug2</option>
    <option value="tuyarelay1">Relais 1 — tuyarelay1</option>
    <option value="tuyarelay2">Relais 2 — tuyarelay2</option>
  </select>

  <!-- Nouveau : Images de contenu -->
  <h3>Image du contenu</h3>
  <div class="row">
    <div class="cols">
      <div>
        <label for="targetSelect">Cible à illustrer</label>
        <select id="targetSelect" aria-label="Choisir la cible">
          <option value="dwell">Carré (dwell)</option>
          <option value="plug1">Carte: plug1</option>
          <option value="plug2">Carte: plug2</option>
          <option value="tuyarelay1">Carte: tuyarelay1</option>
          <option value="tuyarelay2">Carte: tuyarelay2</option>
        </select>
      </div>
      <div>
        <label for="imagePreset">Choisir une image (liste)</label>
        <select id="imagePreset"></select>
      </div>
    </div>

    <label for="imageUrl">…ou coller une URL/chemin personnalisé</label>
    <input id="imageUrl" type="url" placeholder="../../images/fills/mon-visuel.webp" />

    <div class="applyRow">
      <button id="applyImageBtn" type="button">Appliquer</button>
      <button id="resetImageBtn" type="button">Réinitialiser</button>
      <small style="opacity:.8">Le SVG reste si aucune image n’est définie. Les choix sont mémorisés localement.</small>
    </div>
  </div>
</div>

<div class="center">
  <div id="dwellWrap" class="tile dwellable" data-action="plug1" aria-label="Activer (dwell)" role="button" tabindex="0" aria-live="polite">
    <!-- SVG par défaut (fallback) -->
    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M11 2h2v10h-2zM12 22a9 9 0 1 1 7.07-14.93l-1.42 1.42A7 7 0 1 0 12 20a7 7 0 0 0 6.35-4h-2.3A5 5 0 1 1 12 7v2a3 3 0 1 0 3 3h2a5 5 0 1 1-5-5V2z"/>
    </svg>
    <!-- Image de contenu injectée/actualisée au besoin -->
    <img id="dwellContentImg" class="content-img" alt="Visuel de la case" />
    <div class="fill"></div>
  </div>

  <div id="buttons2Wrap" class="grid" style="display:none" aria-label="Panneau 2 boutons">
    <button class="btnCard dwellable" data-action="plug1" aria-label="Prise 1 — plug1">
      <img class="pic" alt="plug1" id="img_plug1"
           src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 100'><rect width='160' height='100' fill='%23181818'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' fill='%23ffffff' font-family='Arial' font-size='16'>plug1</text></svg>">
      <div class="label">plug1</div>
      <div class="fill"></div>
    </button>
    <button class="btnCard dwellable" data-action="tuyarelay1" aria-label="Relais 1 — tuyarelay1">
      <img class="pic" alt="tuyarelay1" id="img_tuyarelay1"
           src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 100'><rect width='160' height='100' fill='%23181818'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' fill='%23ffffff' font-family='Arial' font-size='16'>tuyarelay1</text></svg>">
      <div class="label">tuyarelay1</div>
      <div class="fill"></div>
    </button>
  </div>

  <div id="buttons4Wrap" class="grid four" style="display:none" aria-label="Panneau 4 boutons">
    <button class="btnCard dwellable" data-action="plug1" aria-label="Prise 1 — plug1">
      <img class="pic" alt="plug1" id="img_plug1_b4"
           src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 100'><rect width='160' height='100' fill='%23181818'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' fill='%23ffffff' font-family='Arial' font-size='16'>plug1</text></svg>">
      <div class="label">plug1</div>
      <div class="fill"></div>
    </button>
    <button class="btnCard dwellable" data-action="plug2" aria-label="Prise 2 — plug2">
      <img class="pic" alt="plug2" id="img_plug2"
           src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 100'><rect width='160' height='100' fill='%23181818'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' fill='%23ffffff' font-family='Arial' font-size='16'>plug2</text></svg>">
      <div class="label">plug2</div>
      <div class="fill"></div>
    </button>
    <button class="btnCard dwellable" data-action="tuyarelay1" aria-label="Relais 1 — tuyarelay1">
      <img class="pic" alt="tuyarelay1" id="img_tuyarelay1_b4"
           src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 100'><rect width='160' height='100' fill='%23181818'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' fill='%23ffffff' font-family='Arial' font-size='16'>tuyarelay1</text></svg>">
      <div class="label">tuyarelay1</div>
      <div class="fill"></div>
    </button>
    <button class="btnCard dwellable" data-action="tuyarelay2" aria-label="Relais 2 — tuyarelay2">
      <img class="pic" alt="tuyarelay2" id="img_tuyarelay2"
           src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 100'><rect width='160' height='100' fill='%23181818'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' fill='%23ffffff' font-family='Arial' font-size='16'>tuyarelay2</text></svg>">
      <div class="label">tuyarelay2</div>
      <div class="fill"></div>
    </button>
  </div>
</div>

<pre class="hud" id="hud">ready</pre>

<script>
  // Optional: unregister SW so updates show
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
  }

  // ===== Params & base URLs (tunnel vs local) =====
  const qs = new URLSearchParams(location.search);
  const USE_LOCAL = qs.get('local') === '1';
  const LOCAL_BASE  = "http://192.168.68.134:8123";
  const TUNNEL_BASE = "https://haintelligentclassroom.adaptatech.org";
  const BASE = USE_LOCAL ? LOCAL_BASE : TUNNEL_BASE;

  const URLS = {
    plug1:       `${BASE}/api/webhook/plug1`,
    plug2:       `${BASE}/api/webhook/plug2`,
    tuyarelay1:  `${BASE}/api/webhook/tuyarelay1`,
    tuyarelay2:  `${BASE}/api/webhook/tuyarelay2`,
  };

  // ===== UI refs =====
  const settingsIcon = document.getElementById('settingsIcon');
  const menuPanel = document.getElementById('menuPanel');
  const actionSelect = document.getElementById('actionSelect');
  const dwellWrap    = document.getElementById('dwellWrap');
  const dwellContentImg = document.getElementById('dwellContentImg');
  const buttons2Wrap = document.getElementById('buttons2Wrap');
  const buttons4Wrap = document.getElementById('buttons4Wrap');
  const msInput      = document.getElementById('msInput');
  const hud = document.getElementById('hud');

  // --- Image controls (nouveau)
  const targetSelect = document.getElementById('targetSelect');
  const imagePreset  = document.getElementById('imagePreset');
  const imageUrl     = document.getElementById('imageUrl');
  const applyImageBtn= document.getElementById('applyImageBtn');
  const resetImageBtn= document.getElementById('resetImageBtn');

  // Liste d’images exemple (remplace par tes chemins)
const IMAGES = [
  { label: '— aucune —', value: '' },
  { label: 'Voiture de sport', value: 'images/sportscar.png' },
  { label: 'Excavatrice',      value: 'images/excavator.png' },
  { label: 'Bouteur (bulldozer)', value: 'images/bulldozer.png' },
  { label: 'Autobus',          value: 'images/bus.png' },
  { label: 'Éléphant',         value: 'images/elephant.png' },
  { label: 'Guitare',          value: 'images/guitar.png' },
  { label: 'Ventilateur',      value: 'images/fan.png' },
  { label: 'Ampoule',          value: 'images/lampbulb.png' },
  { label: 'Mélangeur',        value: 'images/standmixer.png' },
  { label: 'Ourson en peluche', value: 'images/teddybear.png' },
  { label: 'Machine à bulles', value: 'images/bubblemachine.png' }
];

  function populateImagePreset(){
    imagePreset.innerHTML = '';
    for (const opt of IMAGES){
      const o = document.createElement('option');
      o.value = opt.value; o.textContent = opt.label;
      imagePreset.appendChild(o);
    }
  }
  populateImagePreset();

  function toggleMenu(force){
    const willShow = (typeof force === 'boolean') ? force : !menuPanel.classList.contains('show');
    menuPanel.classList.toggle('show', willShow);
    settingsIcon.setAttribute('aria-expanded', willShow ? 'true' : 'false');
  }
  settingsIcon.addEventListener('pointerup', (e)=>{ e.stopPropagation(); toggleMenu(); });
  document.addEventListener('pointerup', (e)=>{
    if (!menuPanel.contains(e.target) && !settingsIcon.contains(e.target)) toggleMenu(false);
  });

  // ===== LocalStorage =====
  const LS = {
    get(k, def){ try{ const v = localStorage.getItem(k); return v ?? def; }catch{return def;} },
    set(k, v){ try{ localStorage.setItem(k, v); }catch{} },
    del(k){ try{ localStorage.removeItem(k);}catch{} }
  };

  function log(...a){ console.log(...a); hud.textContent = a.map(String).join(' '); }

  // ===== Mode handling =====
  const modeRadios = () => [...document.querySelectorAll('input[name="mode"]')];
  function setMode(mode){
    LS.set('ui_mode', mode);
    dwellWrap.style.display    = (mode === 'dwell')    ? '' : 'none';
    buttons2Wrap.style.display = (mode === 'buttons2') ? '' : 'none';
    buttons4Wrap.style.display = (mode === 'buttons4') ? '' : 'none';
    modeRadios().forEach(r => r.checked = (r.value === mode));
    log('mode=', mode);
  }
  modeRadios().forEach(r => r.addEventListener('change', () => setMode(r.value)));

  // ===== Initial selection =====
  const initialAction = (qs.get('action') || LS.get('dwell_action', 'plug1')).toLowerCase();
  const initialMode   = (qs.get('mode') || LS.get('ui_mode', 'dwell')).toLowerCase();
  actionSelect.value = ['plug1','plug2','tuyarelay1','tuyarelay2'].includes(initialAction) ? initialAction : 'plug1';
  actionSelect.addEventListener('change', () => {
    LS.set('dwell_action', actionSelect.value);
    dwellWrap.dataset.action = actionSelect.value;
    log('dwell action=', actionSelect.value);
  });
  dwellWrap.dataset.action = actionSelect.value;
  setMode(['dwell','buttons2','buttons4'].includes(initialMode) ? initialMode : 'dwell');
  document.querySelector(`input[name="mode"][value="${initialMode}"]`)?.setAttribute('checked','checked');

  // ===== tuyarelay2 controls (ms + fireMode) =====
  const savedMs = parseInt(LS.get('tuyarelay2_ms', '1500'), 10);
  msInput.value = isFinite(savedMs) ? savedMs : 1500;

  const fireRadios = () => [...document.querySelectorAll('input[name="fireMode2"]')];
  function getFireMode(){ return (LS.get('tuyarelay2_firemode', 'momentary') || 'momentary'); }
  function setFireModeUI(modeStr){ fireRadios().forEach(r => r.checked = (r.value === modeStr)); }
  setFireModeUI(getFireMode());
  fireRadios().forEach(r => r.addEventListener('change', () => {
    LS.set('tuyarelay2_firemode', r.value);
    log('tuyarelay2 firemode =', r.value);
  }));
  msInput.addEventListener('change', () => {
    let v = Math.max(50, Math.min(60000, parseInt(msInput.value || '1500', 10)));
    msInput.value = v;
    LS.set('tuyarelay2_ms', String(v));
    log('tuyarelay2 ms =', v);
  });

  // ===== Dwell tunables =====
  const dwellMs     = Math.max(200, parseInt(qs.get('dwell')   || '1500', 10));
  const outsideHold = Math.max(0,   parseInt(qs.get('outside') || '200',  10));
  const graceMs     = Math.max(0,   parseInt(qs.get('grace')   || '200',  10));
  const cooldownMs  = Math.max(0,   parseInt(qs.get('cooldown')|| '600',  10));
  document.documentElement.style.setProperty('--dwell', dwellMs+'ms');

  let dwellTarget = null, dwellTimer = null, outsideTimer = null, graceTimer = null, cooldownTimer = null;
  let firing = false, inCooldown = false, dwelling = false;
  let lastPos = { x: 0, y: 0 };

  function ensureFill(el){ let f = el.querySelector('.fill'); if (!f){ f = document.createElement('div'); f.className='fill'; el.appendChild(f); } return f; }
  function startFill(el){ const f = ensureFill(el); f.classList.remove('filling'); void f.offsetWidth; f.classList.add('filling'); }
  function cancelFill(el){ const f = el.querySelector('.fill'); if (f) f.classList.remove('filling'); }
  function clearTO(id){ if (id) clearTimeout(id); return null; }
  function elContainsPoint(el, x, y){ const at = document.elementFromPoint(x, y); return !!(at && (at === el || el.contains(at))); }
  function pointerWithin(el, x, y){
    const r = el.getBoundingClientRect();
    if (x < r.left || x > r.right || y < r.top || y > r.bottom) return false;
    return elContainsPoint(el, x, y);
  }

  function urlFor(action){ return URLS[action] || URLS.plug1; }

  // Minimal POST; for tuyarelay2 add ?mode=&ms= from UI (localStorage)
  async function fireUrl(targetEl, action){
    if (firing || inCooldown) return;
    firing = true; inCooldown = true;
    targetEl.classList.remove('error'); targetEl.classList.add('active');

    const base = urlFor(action);
    let full = base + `?t=${Date.now()}`;

    if (action === 'tuyarelay2'){
      const mode = getFireMode();
      const ms   = Math.max(50, Math.min(60000, parseInt(LS.get('tuyarelay2_ms','1500'),10)));
      const p = new URLSearchParams({ mode, ms: String(ms) });
      full = `${base}?${p.toString()}&t=${Date.now()}`;
    }

    log('POST →', full, '· action=', action);

    try{
      const controller = new AbortController();
      const to = setTimeout(()=>controller.abort('timeout'), 8000);
      const res = await fetch(full, { method:'POST', cache:'no-store', redirect:'follow', signal: controller.signal });
      clearTimeout(to);
      log(`status ${res.status || '(opaque)'}`);
    }catch(err){
      targetEl.classList.add('error');
      log('error:', (err && err.message) || err || 'network');
      setTimeout(()=> targetEl.classList.remove('error'), 900);
    }finally{
      setTimeout(()=> targetEl.classList.remove('active'), 450);
      firing = false;
      cooldownTimer = clearTO(cooldownTimer);
      cooldownTimer = setTimeout(()=>{ inCooldown = false; }, cooldownMs);
    }
  }

  function stopDwell(){
    dwelling = false;
    if (dwellTarget) cancelFill(dwellTarget);
    dwellTimer   = clearTO(dwellTimer);
    outsideTimer = clearTO(outsideTimer);
    graceTimer   = clearTO(graceTimer);
    dwellTarget  = null;
  }

  function beginDwell(el, action){
    if (dwelling || firing || inCooldown) return;
    dwelling = true; dwellTarget = el; startFill(el);
    dwellTimer = setTimeout(()=>{ stopDwell(); fireUrl(el, action); }, dwellMs);

    (function watchInside(){
      if (!dwelling || !dwellTarget) return;
      requestAnimationFrame(()=>{
        const insideByPoint = pointerWithin(dwellTarget, lastPos.x, lastPos.y);
        const insideHover = dwellTarget.matches(':hover');
        if (!insideByPoint && !insideHover){
          if (!outsideTimer){
            outsideTimer = setTimeout(()=>{
              if (graceMs <= 0){ stopDwell(); }
              else{
                graceTimer = clearTO(graceTimer);
                graceTimer = setTimeout(()=>{
                  const stillOut = !pointerWithin(dwellTarget, lastPos.x, lastPos.y) && !dwellTarget.matches(':hover');
                  if (stillOut) stopDwell();
                }, graceMs);
              }
            }, outsideHold);
          }
        }else{
          outsideTimer = clearTO(outsideTimer);
          graceTimer   = clearTO(graceTimer);
        }
        watchInside();
      });
    })();
  }

  // Bind dwell + click
  function bindDwell(el){
    el.addEventListener('pointerenter', (e)=>{ lastPos = {x:e.clientX,y:e.clientY}; beginDwell(el, el.dataset.action); });
    el.addEventListener('pointerdown',  (e)=>{ lastPos = {x:e.clientX,y:e.clientY}; beginDwell(el, el.dataset.action); });
    el.addEventListener('pointermove',  (e)=>{ lastPos = {x:e.clientX,y:e.clientY}; });
    el.addEventListener('pointerleave', (e)=>{ lastPos = {x:e.clientX,y:e.clientY}; if (elContainsPoint(el,lastPos.x,lastPos.y)) return; });
    el.addEventListener('click', (e)=>{ e.preventDefault(); stopDwell(); fireUrl(el, el.dataset.action); });
    el.addEventListener('keydown', (e)=>{ if (e.code==='Space'||e.code==='Enter'){ e.preventDefault(); stopDwell(); fireUrl(el, el.dataset.action); }});
  }
  document.querySelectorAll('.dwellable').forEach(bindDwell);

  // Pointer tracking + visibility
  window.addEventListener('pointermove', (e)=>{ lastPos = {x:e.clientX, y:e.clientY}; }, {passive:true});
  document.addEventListener('visibilitychange', ()=>{ if (document.hidden) stopDwell(); });

  // ========= GESTION DES IMAGES DE CONTENU =========
  // Clés LS: img_dwell, img_plug1, img_plug2, img_tuyarelay1, img_tuyarelay2
  const LS_KEYS = {
    dwell:'img_dwell',
    plug1:'img_plug1',
    plug2:'img_plug2',
    tuyarelay1:'img_tuyarelay1',
    tuyarelay2:'img_tuyarelay2'
  };

  function setDwellImage(url){
    if (url && url.trim()){
      dwellContentImg.src = url.trim();
      dwellWrap.classList.add('show-image');
    }else{
      dwellContentImg.removeAttribute('src');
      dwellWrap.classList.remove('show-image'); // revient au SVG
    }
  }

  function setCardImage(id, url){
    const el = document.getElementById(id);
    if (!el) return;
    if (url && url.trim()){
      el.src = url.trim();
    }else{
      // si vide, on laisse le placeholder data:svg déjà en src
      // (tu peux aussi remettre un visuel de fallback ici si tu veux)
    }
  }

  function applySavedImages(){
    setDwellImage(LS.get(LS_KEYS.dwell, ''));
    setCardImage('img_plug1',       LS.get(LS_KEYS.plug1, ''));
    setCardImage('img_plug1_b4',    LS.get(LS_KEYS.plug1, ''));
    setCardImage('img_plug2',       LS.get(LS_KEYS.plug2, ''));
    setCardImage('img_tuyarelay1',  LS.get(LS_KEYS.tuyarelay1, ''));
    setCardImage('img_tuyarelay1_b4',LS.get(LS_KEYS.tuyarelay1, ''));
    setCardImage('img_tuyarelay2',  LS.get(LS_KEYS.tuyarelay2, ''));
  }
  applySavedImages();

  function saveAndApplyTarget(target, url){
    const key = LS_KEYS[target];
    if (!key) return;
    const clean = (url||'').trim();
    if (clean) LS.set(key, clean); else LS.del(key);

    if (target === 'dwell') setDwellImage(clean);
    else{
      // Certaines cibles existent en 2 panneaux (2-boutons et 4-boutons)
      if (target === 'plug1'){
        setCardImage('img_plug1', clean);
        setCardImage('img_plug1_b4', clean);
      }else if (target === 'tuyarelay1'){
        setCardImage('img_tuyarelay1', clean);
        setCardImage('img_tuyarelay1_b4', clean);
      }else{
        setCardImage(`img_${target}`, clean);
      }
    }
    log('image set:', target, clean || '(none)');
  }

  // UI events pour sélection d’image
  imagePreset.addEventListener('change', ()=>{
    if (imagePreset.value) imageUrl.value = imagePreset.value;
  });

  applyImageBtn.addEventListener('click', ()=>{
    const target = targetSelect.value;
    const url = imageUrl.value || imagePreset.value || '';
    saveAndApplyTarget(target, url);
  });

  resetImageBtn.addEventListener('click', ()=>{
    const target = targetSelect.value;
    saveAndApplyTarget(target, '');
    imageUrl.value = '';
    imagePreset.value = '';
  });

  // Auto-préselection du preset si une image est déjà sauvegardée
  (function reflectCurrentSelection(){
    const t = targetSelect.value;
    const key = LS_KEYS[t];
    if (!key) return;
    const cur = LS.get(key, '');
    if (cur){
      imageUrl.value = cur;
      const preset = IMAGES.find(i=>i.value===cur);
      imagePreset.value = preset ? preset.value : '';
    }else{
      imageUrl.value = '';
      imagePreset.value = '';
    }
  })();

  // Quand on change de cible, on reflète sa valeur sauvegardée
  targetSelect.addEventListener('change', ()=>{
    const t = targetSelect.value;
    const key = LS_KEYS[t];
    const cur = LS.get(key, '');
    imageUrl.value = cur || '';
    imagePreset.value = IMAGES.find(i=>i.value===cur)?.value || '';
  });

  log(`ready · base=${BASE}`);
</script>
</body>
</html>
