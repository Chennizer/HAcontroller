<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contr√¥leur Adaptatech</title>
  <style>
    html, body {
      height: 100%; margin: 0;
      background: #0b0b0b; display: grid; place-items: center;
      color: white;
    }
    button {
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      padding: 1rem 2rem;
      border: none;
      border-radius: 20px;
      background: #294936;
      color: white;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    button:active { transform: scale(0.97); }
  </style>
</head>
<body>

  <button id="activate">Activer le jouet</button>

  <script>
  console.log("‚úÖ Controller script loaded");

  const HA_URL = "https://haintelligentclassroom.adaptatech.org";
  const WEBHOOK_ID = "toy_relay";

  // Tiny HUD
  const hud = document.createElement('pre');
  Object.assign(hud.style, {
    position: 'fixed',
    bottom: '12px',
    left: '12px',
    maxWidth: '80vw',
    maxHeight: '40vh',
    overflow: 'auto',
    padding: '10px 12px',
    background: 'rgba(0,0,0,.6)',
    borderRadius: '10px',
    font: '12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace',
    color: '#fff'
  });
  hud.textContent = 'ready';
  document.body.appendChild(hud);

  function log(...args) {
    console.log("[Controller]", ...args);
    hud.textContent = args.map(x => String(x)).join(' ');
  }

  async function triggerToy() {
    log("üîò Button clicked ‚Üí sending...");
    try {
      const url = `${HA_URL}/api/webhook/${WEBHOOK_ID}?t=${Date.now()}`;
      console.log("Fetch URL:", url);
      const res = await fetch(url, {
        method: "POST",
        redirect: "follow",
        cache: "no-store",
        credentials: "omit"
      });
      const text = await res.text();
      console.log("Fetch response:", res.status, res.url, text);
      log(`‚úÖ status ${res.status}`);
      if (!res.ok) alert(`Erreur: ${res.status}`);
    } catch (e) {
      console.error("Network error:", e);
      log("‚ùå network error:", e.message);
    }
  }

  const btn = document.getElementById("activate");
  if (btn) {
    btn.addEventListener("click", triggerToy);
    console.log("‚úÖ Event listener attached to button");
    log("handler attached");
  } else {
    console.error("‚ùå Button not found!");
    log("ERROR: button not found");
  }

  window.addEventListener('error', (e) => {
    console.error("JS error:", e.message, e);
  });
  </script>

</body>
</html>
