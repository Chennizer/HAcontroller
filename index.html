<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-store" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Contrôleur — Dwell carré</title>
<style>
  :root{
    --bg:#000; --fg:#fff;
    --tile:#111; --tile-border:#333;
    --ok:#1ec97f; --err:#ff6b6b;
    --fill: rgba(255,0,0,.65);
    --size: clamp(260px, 50vmin, 520px);
    --dwell: 1500ms; /* JS updates from ?dwell= */
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    display:grid; place-items:center;
    background:var(--bg); color:var(--fg);
    font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    -webkit-tap-highlight-color:transparent;
  }

  /* ===== Gear button (top-right) ===== */
  #settingsIcon{
    position:fixed; top:14px; right:14px;
    width:44px; height:44px; border-radius:50%;
    background:#ffffff; color:#000; border:2px solid #ff2a8a;
    display:flex; align-items:center; justify-content:center;
    font-size:22px; line-height:1;
    cursor:pointer; z-index:10010;
    box-shadow:0 10px 30px rgba(0,0,0,.6);
  }
  #settingsIcon:active{ transform:scale(.98); }

  /* ===== Options panel ===== */
  #menuPanel{
    position:fixed; top:70px; right:14px;
    width:min(320px, 92vw);
    background:#ffffff; color:#000;
    border:2px solid #111; border-radius:12px;
    box-shadow:0 20px 50px rgba(0,0,0,.55);
    padding:12px; z-index:10011;
    display:none;
  }
  #menuPanel.show{ display:block; }
  #menuPanel h2{ margin:0 0 8px; font-size:16px; }
  #menuPanel label{ display:block; font-weight:600; margin:8px 0 6px; }
  #menuPanel select{
    width:100%;
    background:#fff; color:#000;
    border:2px solid #222; border-radius:10px;
    padding:10px 12px; outline:none; font:inherit;
    max-height:40vh; overflow:auto;
  }
  #menuPanel .hint{ font-size:12px; color:#333; margin-top:8px; }

  .tile{
    width:var(--size); height:var(--size);
    display:grid; place-items:center;
    background:var(--tile);
    border:2px solid var(--tile-border);
    border-radius:24px;
    position:relative; overflow:hidden;
    box-shadow:0 10px 30px rgba(0,0,0,.5);
    touch-action:none;
  }

  .icon{ width:40%; max-width:220px; aspect-ratio:1/1; display:block }
  .icon path{ fill:#ddd; transition:fill .2s ease }
  .tile.active .icon path{ fill:var(--ok) }
  .tile.error  .icon path{ fill:var(--err) }

  /* Dwell square fill from center */
  .fill{
    position:absolute; inset:0;
    margin:auto; width:100%; height:100%;
    background:var(--fill);
    border-radius:inherit;
    transform: scale(0);
    transform-origin: 50% 50%;
    pointer-events:none;
    will-change: transform;
    z-index:1; /* beneath the gear/menu (which are outside anyway) */
  }
  .fill.filling{
    transition: transform var(--dwell) linear;
    transform: scale(1);
  }

  .hud{
    position:fixed; left:12px; bottom:12px;
    background:rgba(0,0,0,.55); color:#fff;
    padding:8px 10px; border-radius:10px;
    font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    max-width:80vw; white-space:pre-wrap; box-shadow:0 6px 20px rgba(0,0,0,.35);
    z-index:5;
  }

  @media (prefers-reduced-motion: reduce){
    .fill.filling{ transition-duration: 1ms; }
  }
</style>
</head>
<body>

<!-- Gear + Menu -->
<button id="settingsIcon" title="Options" aria-haspopup="true" aria-expanded="false">⚙️</button>

<div id="menuPanel" role="dialog" aria-label="Options">
  <h2>Options</h2>
  <label for="actionSelect">Action du carré (dwell)</label>
  <select id="actionSelect" aria-label="Choisir l'action">
    <option value="relay">Relais Tuya — impulsion</option>
    <option value="plug">Prise — toy_relay</option>
  </select>
  <div class="hint">Le carré déclenchera l’action sélectionnée.</div>
</div>

<!-- Dwell tile -->
<div class="tile" id="tile" aria-label="Activer (dwell)" role="button" tabindex="0" aria-live="polite">
  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M11 2h2v10h-2zM12 22a9 9 0 1 1 7.07-14.93l-1.42 1.42A7 7 0 1 0 12 20a7 7 0 0 0 6.35-4h-2.3A5 5 0 1 1 12 7v2a3 3 0 1 0 3 3h2a5 5 0 1 1-5-5V2z"/>
  </svg>
  <div class="fill" id="fill"></div>
</div>

<pre class="hud" id="hud">ready</pre>

<script>
  // Optional: nuke any stale service worker caching this path
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
  }

  // === CONFIG (Cloudflare Tunnel for both actions) ===
  const TUNNEL = "https://haintelligentclassroom.adaptatech.org";
  const URL_RELAY_GO = `${TUNNEL}/api/webhook/tuyarelay`;  // Relais Tuya
  const URL_PLUG_ON  = `${TUNNEL}/api/webhook/toy_relay`;  // Prise

  // UI refs
  const settingsIcon = document.getElementById('settingsIcon');
  const menuPanel    = document.getElementById('menuPanel');
  const select       = document.getElementById('actionSelect');
  const tile = document.getElementById('tile');
  const fill = document.getElementById('fill');
  const hud  = document.getElementById('hud');

  // Toggle menu
  function toggleMenu(force){
    const willShow = (typeof force === 'boolean') ? force : !menuPanel.classList.contains('show');
    menuPanel.classList.toggle('show', willShow);
    settingsIcon.setAttribute('aria-expanded', willShow ? 'true' : 'false');
  }
  settingsIcon.addEventListener('pointerup', (e)=>{ e.stopPropagation(); toggleMenu(); });
  document.addEventListener('pointerup', (e)=>{
    if (!menuPanel.contains(e.target) && !settingsIcon.contains(e.target)) toggleMenu(false);
  });

  // Initial selection via ?action=relay|plug or saved value
  const qs = new URLSearchParams(location.search);
  const saved = localStorage.getItem('controller_action');
  const initialAction = (qs.get('action') || saved || 'relay').toLowerCase();
  if ([...select.options].some(o => o.value === initialAction)) {
    select.value = initialAction;
  }
  select.addEventListener('change', () => {
    localStorage.setItem('controller_action', select.value);
    log(`action=${select.value}`);
  });

  // Dwell tunables (query string)
  const dwellMs     = Math.max(200, parseInt(qs.get('dwell')   || '1500', 10));
  const outsideHold = Math.max(0,   parseInt(qs.get('outside') || '200',  10));
  const graceMs     = Math.max(0,   parseInt(qs.get('grace')   || '200',  10));
  const cooldownMs  = Math.max(0,   parseInt(qs.get('cooldown')|| '600',  10));
  document.documentElement.style.setProperty('--dwell', dwellMs+'ms');

  let outsideTimer = null, graceTimer = null, cooldownTimer = null;
  let firing = false, inCooldown = false, dwelling = false;
  let lastPos = { x: 0, y: 0 };

  const log = (...a)=>{ console.log(...a); hud.textContent = a.map(String).join(' '); };

  function startFill(){
    fill.classList.remove('filling'); void fill.offsetWidth; fill.classList.add('filling');
  }
  function cancelFill(){ fill.classList.remove('filling'); }
  function clearTO(id){ if (id) clearTimeout(id); return null; }

  function elContainsPoint(el, x, y){
    const at = document.elementFromPoint(x, y);
    return !!(at && (at === el || el.contains(at)));
  }
  function pointerWithin(el, x, y){
    const r = el.getBoundingClientRect();
    if (x < r.left || x > r.right || y < r.top || y > r.bottom) return false;
    return elContainsPoint(el, x, y);
  }

  function currentUrl(){
    return (select.value === 'plug') ? URL_PLUG_ON : URL_RELAY_GO;
  }

  async function fire(){
    if (firing || inCooldown) return;
    firing = true; inCooldown = true;
    tile.classList.remove('error'); tile.classList.add('active');

    const action = select.value;
    const url = currentUrl();
    log('POST →', url, '· action=', action);

    try{
      const controller = new AbortController();
      const to = setTimeout(()=>controller.abort('timeout'), 8000);
      const res = await fetch(url + `?t=${Date.now()}`, {
        method:'POST',
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ from:"github-page", action }),
        cache:'no-store', credentials:'omit', redirect:'follow', signal: controller.signal
      });
      clearTimeout(to);
      log(`status ${res.status}`);
      if (!res.ok) throw new Error('HTTP '+res.status);
    }catch(err){
      tile.classList.add('error');
      log('error:', (err && err.message) || err || 'network');
      setTimeout(()=> tile.classList.remove('error'), 900);
    }finally{
      setTimeout(()=> tile.classList.remove('active'), 450);
      firing = false;
      cooldownTimer = clearTO(cooldownTimer);
      cooldownTimer = setTimeout(()=>{ inCooldown = false; }, cooldownMs);
    }
  }

  function stopDwell(){
    dwelling = false;
    cancelFill();
    outsideTimer = clearTO(outsideTimer);
    graceTimer = clearTO(graceTimer);
  }

  function beginDwell(){
    if (dwelling || firing || inCooldown) return;
    dwelling = true;
    startFill();
    const tm = setTimeout(()=>{ stopDwell(); fire(); }, dwellMs);
    // watchdog to confirm we stay inside
    (function watchInside(){
      if (!dwelling) return;
      requestAnimationFrame(()=>{
        const insideByPoint = pointerWithin(tile, lastPos.x, lastPos.y);
        const insideHover = tile.matches(':hover');
        if (!insideByPoint && !insideHover){
          if (!outsideTimer){
            outsideTimer = setTimeout(()=>{
              if (graceMs <= 0){ stopDwell(); }
              else{
                graceTimer = clearTO(graceTimer);
                graceTimer = setTimeout(()=>{
                  const stillOut = !pointerWithin(tile, lastPos.x, lastPos.y) && !tile.matches(':hover');
                  if (stillOut) stopDwell();
                }, graceMs);
              }
            }, outsideHold);
          }
        }else{
          outsideTimer = clearTO(outsideTimer);
          graceTimer = clearTO(graceTimer);
        }
        watchInside();
      });
    })();
  }

  // Pointer events
  tile.addEventListener('pointerenter', (e)=>{
    lastPos = {x: e.clientX, y: e.clientY};
    outsideTimer = clearTO(outsideTimer);
    graceTimer = clearTO(graceTimer);
    beginDwell();
  });
  tile.addEventListener('pointermove', (e)=>{ lastPos = {x: e.clientX, y: e.clientY}; });
  tile.addEventListener('pointerleave', (e)=>{
    lastPos = {x: e.clientX, y: e.clientY};
    if (elContainsPoint(tile, lastPos.x, lastPos.y)) return;
  });
  tile.addEventListener('pointerdown', (e)=>{
    lastPos = {x: e.clientX, y: e.clientY};
    outsideTimer = clearTO(outsideTimer);
    graceTimer = clearTO(graceTimer);
    beginDwell();
  });
  tile.addEventListener('pointerup',   (e)=>{ lastPos = {x: e.clientX, y: e.clientY}; });
  tile.addEventListener('pointercancel',(e)=>{ lastPos = {x: e.clientX, y: e.clientY}; });

  // Click / keyboard
  tile.addEventListener('click', (e)=>{ e.preventDefault(); stopDwell(); fire(); });
  tile.addEventListener('keydown', (e)=>{
    if (e.code === 'Space' || e.code === 'Enter'){ e.preventDefault(); stopDwell(); fire(); }
  });

  // Track pointer
  window.addEventListener('pointermove', (e)=>{ lastPos = {x: e.clientX, y: e.clientY}; }, {passive:true});

  log(`ready · action=${select.value} · dwell=${dwellMs}ms · outsideHold=${outsideHold}ms · grace=${graceMs}ms · cooldown=${cooldownMs}ms
(Click the ⚙️ to choose which webhook to fire)`);
</script>
</body>
</html>
